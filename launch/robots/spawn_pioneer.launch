<!-- Assumes Gazebo is already running -->
<launch>
  <!-- This launch file includes all the nodes needed to setup a simulated pioneer for navigation -->

  <!-- Settings (Robot position args are overidden by spawn_world.launch)-->
  <arg name="x" default="0.0" />
  <arg name="y" default="0.0" />
  <arg name="z" default="0.0" />
  <arg name="yaw" default="0.0" />
  <!-- Rotation in radians. -->
  <arg name="level" default="level1" />
  <arg name="navigate" default="true" />
  <arg name="3d" default="true" />

  <!-- model_name determines the topics to be published, and serves as a unique identifier for Gazebo -->
  <arg name="model_type" value="pioneer" />
  <!-- The location of the mesh files for our robot -->
  <arg name="model_dir" value="$(find uml_3d_race)/resources/models/pioneer/meshes" />
  <!-- The location of the top-level xacro file that defines the robot  -->
  <arg name="model_file" value="$(find uml_3d_race)/resources/models/pioneer/defs/pioneer.xacro" />

  <!-- Robot topics and links-->
  <arg name="laser_topic" value="frontscan_filtered" />
  <arg name="pointcloud_topic" value="kinect/depth/points" />
  <arg name="cmd_vel_topic" value="cmd_vel" />
  <arg name="odom_topic" value="odom" />
  <arg name="odom_link" value="odom"/>
  <arg name="base_link" value="base_link" />


  <!-- Load robot_description parameter from top-level pioneer3dx.xacro file -->
  <!-- Also send the model_dir and model_type as arguments to help us generate the model -->
  <param name="$(arg model_type)/robot_description" command="$(find xacro)/xacro --inorder $(arg model_file) model_dir:=$(arg model_dir) model_name:=$(arg model_type)" />

  <!-- publish TFs for static/fixed links (based on the robot_description parameter) -->
  <node pkg="robot_state_publisher" type="robot_state_publisher" name="state_publisher" output="screen">
    <param name="publish_frequency" type="double" value="30.0"/>
    <remap from="robot_description" to="$(arg model_type)/robot_description"/>
  </node>

  <!-- Without the joint_state_publisher, non-fixed joints that are not published by a plugin
       (i.e. - the swivel_link joint) will not have it's transform published.
       joint_state_publisher also uses the robot_description parameter. -->
  <node pkg="joint_state_publisher" type="joint_state_publisher" name="joint_publisher" output="screen">
    <remap from="robot_description" to="$(arg model_type)/robot_description"/>
  </node>

  <!-- Spawn robot into Gazebo -->
  <node name="urdf_spawner" pkg="gazebo_ros" type="spawn_model" args="
    -urdf
    -model $(arg model_type)
    -param $(arg model_type)/robot_description
    -x $(arg x)
    -y $(arg y)
    -z $(arg z)
    -Y $(arg yaw)">
  </node>

  <!-- Laser filter to remove infinite values from the front facing laser -->
  <!-- http://wiki.ros.org/laser_filters -->
  <node name="laser_filter" pkg="laser_filters" type="scan_to_scan_filter_chain">
    <rosparam command="load" file="$(find uml_3d_race)/resources/config/pioneer/laserfilter_config.yaml" />
    <remap from="scan" to="frontscan" />
    <remap from="scan_filtered" to="frontscan_filtered" />
  </node>

  <!-- Start Kinect to Laser Converter -->
  <include file="$(find uml_3d_race)/launch/navigation/pcl_to_laser.launch">
    <arg name="robot" value="$(arg model_type)" />
  </include>

  <!-- Start pointcloud filter-->
  <include file="$(find uml_3d_race)/launch/navigation/pointcloud_filter.launch">
      <arg name="namespace" value="" />
      <arg name="input_cloud" value="$(arg pointcloud_topic)" />
      <arg name="output_cloud" value="$(arg pointcloud_topic)_filtered" />
  </include>

  <!-- Start nav stack or mapping mode-->
  <group if="$(arg navigate)">
    <!-- Start 3d Nav Stack -->
    <include file="$(find uml_3d_race)/launch/navigation/navigation_3d.launch" if="$(arg 3d)">
      <arg name="namespace" value="" />
      <arg name="robot_type" value="$(arg model_type)" />
      <arg name="map" value="$(arg level)" />
      <arg name="init_x" value="$(arg x)" />
      <arg name="init_y" value="$(arg y)" />
      <arg name="init_yaw" value="$(arg yaw)" />
      <arg name="has_laser" value="true" />
      <arg name="laser_topic" value="$(arg laser_topic)" />
      <arg name="pointcloud_topic" value="$(arg pointcloud_topic)_filtered" />
      <arg name="cmd_vel_topic" value="$(arg cmd_vel_topic)" />
      <arg name="odom_topic" value="$(arg odom_topic)" />
      <arg name="odom_link" value="$(arg odom_link)"/>
      <arg name="base_link" value="$(arg base_link)" />
    </include>

    <!-- Start 2d Nav Stack -->
    <include file="$(find uml_3d_race)/launch/navigation/navigation_2d.launch" unless="$(arg 3d)">
      <arg name="namespace" value="" />
      <arg name="robot_type" value="$(arg model_type)" />
      <arg name="map" value="$(arg level)" />
      <arg name="init_x" value="$(arg x)" />
      <arg name="init_y" value="$(arg y)" />
      <arg name="init_yaw" value="$(arg yaw)" />
      <arg name="move_base_config" value="default" />
      <arg name="laser_topic" value="$(arg laser_topic)" />
      <arg name="cmd_vel_topic" value="$(arg cmd_vel_topic)" />
      <arg name="odom_topic" value="$(arg odom_topic)" />
      <arg name="odom_link" value="$(arg odom_link)"/>
      <arg name="base_link" value="$(arg base_link)" />
     </include>
  </group>

  <group unless="$(arg navigate)">
    <!-- Start Mapping -->
    <include file="$(find uml_3d_race)/launch/navigation/map_teleop.launch">
      <arg name="namespace" value="" />
      <arg name="map" value="$(arg level)" />
      <arg name="static_2d_map" value="false" />
      <arg name="3d" value="true" />
      <arg name="init_x" value="$(arg x)" />
      <arg name="init_y" value="$(arg y)" />
      <arg name="init_yaw" value="$(arg yaw)" />
      <arg name="laser_topic" value="$(arg laser_topic)" />
      <arg name="pointcloud_topic" value="$(arg pointcloud_topic)_filtered" />
      <arg name="cmd_vel_topic" value="$(arg cmd_vel_topic)" />
      <arg name="odom_link" value="$(arg odom_link)"/>
      <arg name="base_link" value="$(arg base_link)" />
    </include>
  </group>

</launch>
